<html>
    <head>
        <link rel="stylesheet" href="style.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            button {
                background-color: #056CF2;
                color: #fff;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <div style="
            display: flex;
            flex-direction: column;
            height: 100%;
            box-sizing: border-box;
            overflow: hidden;">
            <div style="
                display: flex;
                background-color: #056CF2;">
                <div style="
                    display: flex;
                    align-items: center;
                    padding: 1rem;"
                    id="btnBack">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="m313-440 196 196q12 12 11.5 28T508-188q-12 11-28 11.5T452-188L188-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l264-264q11-11 27.5-11t28.5 11q12 12 12 28.5T508-715L313-520h447q17 0 28.5 11.5T800-480q0 17-11.5 28.5T760-440H313Z" /></svg>
                </div>
                <div style="
                    display: flex;
                    align-items: center;
                    flex: 1;
                    min-width: 0;
                    padding: 1rem;
                    padding-left: 0rem;
                    font-size: 1.5rem;
                    font-weight: bold;
                    color: #fff;">
                    Results
                </div>
            </div>
            <div style="
                min-height: 0;
                overflow: auto;">
                <div style="
                    padding: 1rem;
                    font-size: 1.5rem;
                    font-weight: bold;">
                    Patient details:
                </div>
                <div style="
                    display: flex;
                    font-size: 0.7rem;">
                    <div>
                        <div style="
                            padding: 1rem;
                            padding-top: 0rem;
                            text-align: center;">
                            <img style="
                                width: 5rem;
                                height: 5rem;
                                border-radius: 50%;
                                object-fit: cover;"
                                src="../api/uploads/avatar/image.png"
                                id="imgAvatar">
                        </div>
                        <div style="
                            padding: 1rem;
                            padding-top: 0rem;
                            text-align: center;">
                            <button style="
                                padding: 0.5rem;
                                font-size: 0.7rem;
                                background-color: #fff;
                                color: #000;"
                                id="btnView">
                                View Medical Info
                            </button>
                        </div>
                    </div>
                    <div style="
                        flex: 1;
                        min-width: 0;">
                        <div style="
                            padding: 1rem;
                            padding-top: 0rem;
                            padding-left: 0rem;
                            font-weight: bold;
                            font-size: 1rem;"
                            id="panelFullname">
                        </div>
                        <div style="
                            display: flex;">
                            <div style="
                                padding: 1rem;
                                padding-top: 0rem;
                                padding-left: 0rem;
                                font-weight: bold;">
                                Birthdate:
                            </div>
                            <div style="
                                padding: 1rem;
                                padding-top: 0rem;
                                padding-left: 0rem;"
                                id="panelBirthdate">
                            </div>
                        </div>
                        <div style="
                            display: flex;">
                            <div style="
                                padding: 1rem;
                                padding-top: 0rem;
                                padding-left: 0rem;
                                font-weight: bold;">
                                Gender:
                            </div>
                            <div style="
                                padding: 1rem;
                                padding-top: 0rem;
                                padding-left: 0rem;"
                                id="panelGender">
                            </div>
                        </div>
                        <div style="
                            display: flex;">
                            <div style="
                                padding: 1rem;
                                padding-top: 0rem;
                                padding-left: 0rem;
                                font-weight: bold;">
                                Email:
                            </div>
                            <div style="
                                padding: 1rem;
                                padding-top: 0rem;
                                padding-left: 0rem;"
                                id="panelEmail">
                            </div>
                        </div>
                        <div style="
                            display: flex;">
                            <div style="
                                padding: 1rem;
                                padding-top: 0rem;
                                padding-left: 0rem;
                                font-weight: bold;">
                                Phone:
                            </div>
                            <div style="
                                padding: 1rem;
                                padding-top: 0rem;
                                padding-left: 0rem;"
                                id="panelPhone">
                            </div>
                        </div>
                        <div style="
                            display: flex;">
                            <div style="
                                padding: 1rem;
                                padding-top: 0rem;
                                padding-left: 0rem;
                                font-weight: bold;">
                                Address:
                            </div>
                            <div style="
                                padding: 1rem;
                                padding-top: 0rem;
                                padding-left: 0rem;"
                                id="panelAddress">
                            </div>
                        </div>
                    </div>
                </div>
                <div style="
                    display: flex;">
                    <div style="
                        display: flex;
                        align-items: center;
                        padding: 1rem;
                        font-size: 1.5rem;
                        font-weight: bold;">
                        Urgency:
                    </div>
                    <div style="
                        display: flex;
                        align-items: center;
                        flex: 1;
                        min-width: 0;
                        padding: 1rem;
                        padding-left: 0rem;
                        font-size: 1.5rem;" id="panelUrgency">
                    </div>
                </div>
                <div style="
                    padding: 1rem;
                    font-size: 1.5rem;
                    font-weight: bold;">
                    Consultation Summary
                </div>
                <div style="
                    padding: 1rem;
                    padding-top: 0rem;">
                    <div id="panelSummary">
                    </div>
                </div>
                <div style="
                    padding: 1rem;
                    font-size: 1.5rem;
                    font-weight: bold;">
                    Preliminary Impression
                </div>
                <div style="
                    padding: 1rem;
                    padding-top: 0rem;" id="panelImpression">
                </div>
                <div style="
                    padding: 1rem;
                    font-size: 1.5rem;
                    font-weight: bold;">
                    Self-Care Advice
                </div>
                <div style="
                    padding: 1rem;
                    padding-top: 0rem;" id="panelAdvice">
                </div>
                <div style="
                    padding: 1rem;">
                    <button id="btnChat">
                        Chat with Patient
                    </button>
                </div>
            </div>
        </div>
        <script src="script.js"></script>
        <script>
            const btnBack = document.getElementById("btnBack");
            const imgAvatar = document.getElementById("imgAvatar");
            const btnView = document.getElementById("btnView");
            const panelFullname = document.getElementById("panelFullname");
            const panelBirthdate = document.getElementById("panelBirthdate");
            const panelGender = document.getElementById("panelGender");
            const panelEmail = document.getElementById("panelEmail");
            const panelPhone = document.getElementById("panelPhone");
            const panelAddress = document.getElementById("panelAddress");
            const panelUrgency = document.getElementById("panelUrgency");
            const panelSummary = document.getElementById("panelSummary");
            const panelImpression = document.getElementById("panelImpression");
            const panelAdvice = document.getElementById("panelAdvice");
            const btnChat = document.getElementById("btnChat");
            initialize();

            async function initialize() {
                let id = new URLSearchParams(location.search).get("id");

                const response = await fetch(`../api/doctor/case/?id=${id}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": g_data.session
                    }
                });

                const data = await response.json();
                console.log(data);
                btnChat.onclick = () => location.href = `chat.html?id=${id}`;
                renderUser(data.case.user_id);
                btnView.onclick = () => location.href = `medical.html?id=${data.case.user_id}`;
                const details = JSON.parse(data.case.details);

                for (let detail of details) {
                    panelSummary.innerHTML += /*html*/`
                            <div style="
                                display: flex;">
                                <div style="
                                    flex: 1;
                                    min-width: 0;
                                    padding: 1rem;
                                    font-size: 0.7rem;
                                    font-weight: bold;
                                    word-wrap: break-word;
                                    border: 1px solid #555;">
                                    ${g_escapeHtml(detail.field)}
                                </div>
                                <div style="
                                    flex: 2;
                                    min-width: 0;
                                    padding: 1rem;
                                    font-size: 0.7rem;
                                    border: 1px solid #555;">
                                    ${g_escapeHtml(detail.content)}
                                </div>
                            </div>
                        `;
                }

                switch (data.case.urgency) {
                    case "low":
                        panelUrgency.innerHTML = /*html*/`
                                <span style="color: #0a0;">Low</span>
                            `;

                        break;
                    case "medium":
                        panelUrgency.innerHTML = /*html*/`
                                <span style="color: #aa0;">Medium</span>
                            `;

                        break;
                    case "high":
                        panelUrgency.innerHTML = /*html*/`
                                <span style="color: #a00;">High</span>
                            `;

                        break;
                }

                panelImpression.textContent = data.case.preliminary_impression;
                panelAdvice.textContent = data.case.self_care_advice;
            }

            async function renderUser(userId) {
                const response = await fetch(`../api/doctor/user/?id=${userId}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": g_data.session
                    }
                });

                const data = await response.json();
                console.log(data);
                const user = data.user;
                imgAvatar.src = `../api/uploads/avatar/${user.avatar}`;
                panelFullname.textContent = `${user.lastname}, ${user.firstname} ${user.middleinitial}`;
                panelBirthdate.textContent = user.birthdate;
                panelGender.textContent = user.gender;
                panelEmail.textContent = user.email;
                panelPhone.textContent = user.phone;
                panelAddress.textContent = user.street;

                if (user.barangay != "") {
                    const response = await fetch(`https://psgc.cloud/api/v2/barangays/${user.barangay}`);
                    const data = await response.json();
                    panelAddress.textContent += `, ${data.data.name}`;
                }

                if (user.city != "") {
                    const response = await fetch(`https://psgc.cloud/api/v2/cities-municipalities/${user.city}`);
                    const data = await response.json();
                    panelAddress.textContent += `, ${data.data.name}`;
                }

                if (user.province != "") {
                    const response = await fetch(`https://psgc.cloud/api/v2/provinces/${user.province}`);
                    const data = await response.json();
                    panelAddress.textContent += `, ${data.data.name}`;
                }
            }

            btnBack.onclick = () => location.href = "home.html";
        </script>
    </body>
</html>