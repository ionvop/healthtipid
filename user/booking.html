<html>
    <head>
        <link rel="stylesheet" href="style.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>

        </style>
    </head>
    <body>
        <div style="
            display: flex;
            flex-direction: column;
            height: 100%;
            box-sizing: border-box;
            overflow: hidden;">
            <div style="
                display: flex;
                background-color: var(--theme);">
                <div style="
                    display: flex;
                    align-items: center;
                    padding: 1rem;"
                    id="btnBack">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="m313-440 196 196q12 12 11.5 28T508-188q-12 11-28 11.5T452-188L188-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l264-264q11-11 27.5-11t28.5 11q12 12 12 28.5T508-715L313-520h447q17 0 28.5 11.5T800-480q0 17-11.5 28.5T760-440H313Z"/></svg>
                </div>
                <div style="
                    display: flex;
                    align-items: center;
                    flex: 1;
                    min-width: 0;
                    padding: 1rem;
                    padding-left: 0rem;
                    font-size: 1.5rem;
                    font-weight: bold;
                    color: #fff;">
                    Bookings
                </div>
            </div>
            <div style="
                flex: 1;
                min-height: 0;
                overflow: auto;">
                <div style="
                    display: flex;">
                    <div style="
                        flex: 1;
                        min-width: 0;
                        padding: 1rem;
                        text-align: center;">
                        <button id="btnDoctor">
                            View Doctor
                        </button>
                    </div>
                    <div style="
                        flex: 1;
                        min-width: 0;
                        padding: 1rem;
                        text-align: center;">
                        <button id="btnCase">
                            View Case
                        </button>
                    </div>
                </div>
                <div style="
                    display: flex;">
                    <div style="
                        flex: 1;
                        min-width: 0;">
                    </div>
                    <div style="
                        display: flex;
                        align-items: center;
                        padding: 1rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-40q0-17 11.5-28.5T280-880q17 0 28.5 11.5T320-840v40h320v-40q0-17 11.5-28.5T680-880q17 0 28.5 11.5T720-840v40h40q33 0 56.5 23.5T840-720v187q0 17-11.5 28.5T800-493q-17 0-28.5-11.5T760-533v-27H200v400h232q17 0 28.5 11.5T472-120q0 17-11.5 28.5T432-80H200Zm520 40q-83 0-141.5-58.5T520-240q0-83 58.5-141.5T720-440q83 0 141.5 58.5T920-240q0 83-58.5 141.5T720-40Zm20-208v-92q0-8-6-14t-14-6q-8 0-14 6t-6 14v91q0 8 3 15.5t9 13.5l61 61q6 6 14 6t14-6q6-6 6-14t-6-14l-61-61Z"/></svg>
                    </div>
                    <div style="
                        display: flex;
                        align-items: center;
                        padding: 1rem;"
                        id="panelCurrentDatetime">
                    </div>
                    <div style="
                        flex: 1;
                        min-width: 0;">
                    </div>
                </div>
                <div style="
                    display: flex;">
                    <div style="
                        flex: 1;
                        min-width: 0;">
                    </div>
                    <div style="
                        display: flex;
                        align-items: center;
                        padding: 1rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="M200-80q-17 0-28.5-11.5T160-120q0-17 11.5-28.5T200-160h40v-120q0-61 28.5-114.5T348-480q-51-32-79.5-85.5T240-680v-120h-40q-17 0-28.5-11.5T160-840q0-17 11.5-28.5T200-880h560q17 0 28.5 11.5T800-840q0 17-11.5 28.5T760-800h-40v120q0 61-28.5 114.5T612-480q51 32 79.5 85.5T720-280v120h40q17 0 28.5 11.5T800-120q0 17-11.5 28.5T760-80H200Z"/></svg>
                    </div>
                    <div style="
                        display: flex;
                        align-items: center;
                        padding: 1rem;"
                        id="panelTimeLeft">
                    </div>
                    <div style="
                        flex: 1;
                        min-width: 0;">
                    </div>
                </div>
                <div style="
                    display: flex;">
                    <div style="
                        flex: 1;
                        min-width: 0;">
                    </div>
                    <div style="
                        display: flex;
                        align-items: center;
                        padding: 1rem;
                        font-weight: bold;">
                        Start:
                    </div>
                    <div style="
                        display: flex;
                        align-items: center;
                        padding: 1rem;"
                        id="panelStart">
                    </div>
                    <div style="
                        flex: 1;
                        min-width: 0;">
                    </div>
                </div>
                <div style="
                    display: flex;">
                    <div style="
                        flex: 1;
                        min-width: 0;">
                    </div>
                    <div style="
                        display: flex;
                        align-items: center;
                        padding: 1rem;
                        font-weight: bold;">
                        End:
                    </div>
                    <div style="
                        display: flex;
                        align-items: center;
                        padding: 1rem;"
                        id="panelEnd">
                    </div>
                    <div style="
                        flex: 1;
                        min-width: 0;">
                    </div>
                </div>
                <div style="
                    padding: 1rem;
                    text-align: center;">
                    <button style="
                        width: 100%;"
                        id="btnChat">
                        Open Chat
                    </button>
                </div>
            </div>
        </div>
        <script src="script.js"></script>
        <script>
            const btnBack = document.getElementById("btnBack");
            const btnDoctor = document.getElementById("btnDoctor");
            const btnCase = document.getElementById("btnCase");
            const panelCurrentDatetime = document.getElementById("panelCurrentDatetime");
            const panelTimeLeft = document.getElementById("panelTimeLeft");
            const panelStart = document.getElementById("panelStart");
            const panelEnd = document.getElementById("panelEnd");
            const btnChat = document.getElementById("btnChat");
            initialize();

            async function initialize() {
                let timeslotId = new URLSearchParams(location.search).get("id");

                const response = await fetch(`../api/bookings/?id=${timeslotId}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": g_data.session
                    }
                });

                const data = await response.json();
                console.log(data);
                btnDoctor.onclick = () => location.href = `doctor.html?id=${data.timeslot.doctor_id}`;
                btnCase.onclick = () => location.href = `case.html?id=${data.timeslot.case_id}`;
                btnChat.onclick = () => location.href = `doctorChat.html?id=${data.timeslot.case_id}`;
                panelCurrentDatetime.textContent = new Date().toLocaleString();
                panelTimeLeft.textContent = formatDuration(data.timeslot.start_time - Math.floor(Date.now() / 1000)) + " until the start of your appointment.";
                panelStart.textContent = new Date(data.timeslot.start_time * 1000).toLocaleString();
                panelEnd.textContent = new Date(data.timeslot.end_time * 1000).toLocaleString();
            }

            function formatDuration(seconds) {
                if (seconds === 0) return "0 seconds";

                const units = [
                    { label: "day", value: 86400 },
                    { label: "hour", value: 3600 },
                    { label: "minute", value: 60 },
                    { label: "second", value: 1 }
                ];

                const parts = [];

                for (const { label, value } of units) {
                    const amount = Math.floor(seconds / value);

                    if (amount > 0) {
                        parts.push(`${amount} ${label}${amount > 1 ? "s" : ""}`);
                        seconds %= value;
                    }
                }

                if (parts.length === 1) return parts[0];
                return parts.slice(0, -1).join(", ") + " and " + parts[parts.length - 1];
            }

            btnBack.onclick = () => location.href = "bookings.html";
        </script>
    </body>
</html>