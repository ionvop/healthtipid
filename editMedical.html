<html>

<head>
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    button {
      background-color: #056CF2;
      color: #fff;
    }

    textarea {
      background-color: transparent;
      border: 1px solid #056CF2;
      padding: 0.5rem;
      font-size: 0.7rem;
    }
  </style>
</head>

<body>
  <div style="
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
      ">
    <div style="display: flex; background-color: #056CF2">
      <div style="display: flex; align-items: center; padding: 1rem" id="btnBack">
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
          <path
            d="m313-440 196 196q12 12 11.5 28T508-188q-12 11-28 11.5T452-188L188-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l264-264q11-11 27.5-11t28.5 11q12 12 12 28.5T508-715L313-520h447q17 0 28.5 11.5T800-480q0 17-11.5 28.5T760-440H313Z" />
        </svg>
      </div>
      <div style="
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
            padding: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
          ">
        HealthTipid
      </div>
    </div>
    <div style="position: relative; flex: 1; min-width: 0; overflow: hidden">
      <div style="box-sizing: border-box; height: 100%; overflow: auto" class="card">
        <div style="
              padding: 1rem;
              text-align: center;
              font-size: 1.5rem;
              font-weight: bold;
            ">
          Edit Medical Information
        </div>
        <div style="display: flex">
          <div style="flex: 1; min-width: 0">
            <div style="padding: 1rem">Height (cm)</div>
            <div style="padding: 1rem; padding-top: 0rem">
              <input type="number" id="inputHeight" placeholder="e.g. 150" />
            </div>
          </div>
          <div style="flex: 1; min-width: 0">
            <div style="padding: 1rem; padding-left: 0rem">Weight (kg)</div>
            <div style="padding: 1rem; padding-top: 0rem">
              <input type="number" id="inputWeight" placeholder="e.g. 50" />
            </div>
          </div>
          <div style="flex: 1; min-width: 0">
            <div style="padding: 1rem">Blood Type</div>
            <div style="padding: 1rem; padding-top: 0rem">
              <select id="selectBloodType">
                <option value="">Select Blood Type</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
              </select>
            </div>
          </div>
        </div>
        <div style="padding: 1rem">Allergies (comma-separated)</div>
        <div style="padding: 1rem; padding-top: 0rem">
          <input id="inputAllergies" placeholder="e.g. Penicillin, Peanuts, Dust mites" />
        </div>
        <div style="display: flex">
          <div style="flex: 1; min-width: 0">
            <div style="padding: 1rem">Chronic Conditions</div>
            <div style="padding: 1rem; padding-top: 0rem">
              <select id="selectChronicConditions" multiple>
                <option value="Diabetes">Diabetes</option>
                <option value="Hypertension">Hypertension</option>
                <option value="Asthma">Asthma</option>
                <option value="Kidney Disease">Kidney Disease</option>
                <option value="Heart Disease">Heart Disease</option>
                <option value="Cancer">Cancer</option>
                <option value="Epilepsy">Epilepsy</option>
              </select>
            </div>
            <div style="padding: 1rem; padding-top: 0rem">
              <input id="inputOtherChronicConditions" placeholder="Others (comma-separated)" />
            </div>
          </div>
          <div style="flex: 1; min-width: 0">
            <div style="padding: 1rem">Immunization Status</div>
            <div style="padding: 1rem; padding-top: 0rem">
              <select id="selectImmunizationStatus" multiple>
                <option value="COVID-19">COVID-19</option>
                <option value="Flu">Flu</option>
                <option value="Hepatitis B">Hepatitis B</option>
                <option value="Tetanus">Tetanus</option>
                <option value="MMR">MMR</option>
              </select>
            </div>
            <div style="padding: 1rem; padding-top: 0rem">
              <input id="inputOtherImmunizationStatus" placeholder="Others (comma-separated)" />
            </div>
          </div>
        </div>
        <div style="padding: 1rem">
          Past Surgeries / Major Illnesses (comma-separated)
        </div>
        <div style="padding: 1rem; padding-top: 0rem">
          <input id="inputMajorIllnesses" placeholder="e.g. Appendectomy (2015), Dengue fever (2018)" />
        </div>
        <div style="padding: 1rem">Current Medications (comma-separated)</div>
        <div style="padding: 1rem; padding-top: 0rem">
          <input id="inputCurrentMedications" placeholder="e.g. Metformin 500mg twice daily, Aspirin 81mg once daily" />
        </div>
        <div style="padding: 1rem">
          Family Medical History (comma-separated)
        </div>
        <div style="padding: 1rem; padding-top: 0rem">
          <input id="inputFamilyMedicalHistory" placeholder="e.g. Father - Hypertension, Mother - Type 2 Diabetes" />
        </div>
        <div style="display: flex">
          <div style="flex: 1; min-width: 0">
            <div style="padding: 1rem">Lifestyle & Risk Factors</div>
            <div style="display: flex">
              <div style="
                    display: flex;
                    align-items: center;
                    flex: 1;
                    min-width: 0;
                    padding: 1rem;
                    padding-top: 0rem;
                    font-size: 0.7rem;
                  ">
                Smoking Status
              </div>
              <div style="
                    display: flex;
                    align-items: center;
                    flex: 1;
                    min-width: 0;
                    padding: 1rem;
                    padding-top: 0rem;
                    padding-left: 0rem;
                  ">
                <select id="selectSmokingStatus">
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                  <option value="Former">Former</option>
                </select>
              </div>
            </div>
            <div style="display: flex">
              <div style="
                    display: flex;
                    align-items: center;
                    flex: 1;
                    min-width: 0;
                    padding: 1rem;
                    padding-top: 0rem;
                    font-size: 0.7rem;
                  ">
                Alcohol Use
              </div>
              <div style="
                    display: flex;
                    align-items: center;
                    flex: 1;
                    min-width: 0;
                    padding: 1rem;
                    padding-top: 0rem;
                    padding-left: 0rem;
                  ">
                <select id="selectAlcoholUse">
                  <option value="">Select</option>
                  <option value="None">None</option>
                  <option value="Occasionally">Occasionally</option>
                  <option value="Regularly">Regularly</option>
                </select>
              </div>
            </div>
            <div style="display: flex">
              <div style="
                    display: flex;
                    align-items: center;
                    flex: 1;
                    min-width: 0;
                    padding: 1rem;
                    padding-top: 0rem;
                    font-size: 0.7rem;
                  ">
                Physical Activity
              </div>
              <div style="
                    display: flex;
                    align-items: center;
                    flex: 1;
                    min-width: 0;
                    padding: 1rem;
                    padding-top: 0rem;
                    padding-left: 0rem;
                  ">
                <select id="selectPhysicalActivity">
                  <option value="">Select</option>
                  <option value="Sedentary">Sedentary</option>
                  <option value="Light">Light</option>
                  <option value="Moderate">Moderate</option>
                  <option value="Active">Active</option>
                </select>
              </div>
            </div>
            <div style="padding: 1rem; font-size: 0.7rem">
              Dietary Habits (comma-separated)
            </div>
            <div style="padding: 1rem; padding-top: 0rem">
              <input id="inputDietaryHabits" placeholder="e.g. Mostly vegetarian, eats fast food 3x/week" />
            </div>
          </div>
          <div style="display: flex; flex-direction: column">
            <div style="flex: 1; min-height: 0"></div>
            <div style="
                  padding: 1rem;
                  font-size: 0.7rem;
                  color: #555;
                  text-align: center;
                ">
              Last updated:
            </div>
            <div style="
                  padding: 1rem;
                  padding-top: 0rem;
                  font-size: 0.7rem;
                  color: #555;
                  text-align: center;
                " id="panelLastUpdated">
              Never
            </div>
            <div style="padding: 1rem; text-align: center">
              <button id="btnSave">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="script.js"></script>
  <script>
    let btnBack = document.getElementById("btnBack");
    let inputHeight = document.getElementById("inputHeight");
    let inputWeight = document.getElementById("inputWeight");
    let selectBloodType = document.getElementById("selectBloodType");
    let inputAllergies = document.getElementById("inputAllergies");
    let selectChronicConditions = document.getElementById(
      "selectChronicConditions"
    );
    let inputOtherChronicConditions = document.getElementById(
      "inputOtherChronicConditions"
    );
    let selectImmunizationStatus = document.getElementById(
      "selectImmunizationStatus"
    );
    let inputOtherImmunizationStatus = document.getElementById(
      "inputOtherImmunizationStatus"
    );
    let inputMajorIllnesses = document.getElementById("inputMajorIllnesses");
    let inputCurrentMedications = document.getElementById(
      "inputCurrentMedications"
    );
    let inputFamilyMedicalHistory = document.getElementById(
      "inputFamilyMedicalHistory"
    );
    let selectSmokingStatus = document.getElementById("selectSmokingStatus");
    let selectAlcoholUse = document.getElementById("selectAlcoholUse");
    let selectPhysicalActivity = document.getElementById(
      "selectPhysicalActivity"
    );
    let inputDietaryHabits = document.getElementById("inputDietaryHabits");
    let panelLastUpdated = document.getElementById("panelLastUpdated");
    let btnSave = document.getElementById("btnSave");
    initialize();

    async function initialize() {
      let user = await g_getUser();
      if (user == null) return;

      if (user.height != null) inputHeight.value = user.height;
      if (user.weight != null) inputWeight.value = user.weight;
      if (user.blood_type != null) selectBloodType.value = user.blood_type;
      if (user.allergies != null) inputAllergies.value = user.allergies;

      if (user.chronic_conditions != null) {
        let chronicConditions = JSON.parse(user.chronic_conditions);
        if (chronicConditions.diabetes == true)
          selectChronicConditions.querySelector(
            "option[value='Diabetes']"
          ).selected = true;
        if (chronicConditions.hypertension == true)
          selectChronicConditions.querySelector(
            "option[value='Hypertension']"
          ).selected = true;
        if (chronicConditions.asthma == true)
          selectChronicConditions.querySelector(
            "option[value='Asthma']"
          ).selected = true;
        if (chronicConditions.kidneydisease == true)
          selectChronicConditions.querySelector(
            "option[value='Kidney Disease']"
          ).selected = true;
        if (chronicConditions.heartdisease == true)
          selectChronicConditions.querySelector(
            "option[value='Heart Disease']"
          ).selected = true;
        if (chronicConditions.cancer == true)
          selectChronicConditions.querySelector(
            "option[value='Cancer']"
          ).selected = true;
        if (chronicConditions.epilepsy == true)
          selectChronicConditions.querySelector(
            "option[value='Epilepsy']"
          ).selected = true;
        if (chronicConditions.other != null)
          inputOtherChronicConditions.value = chronicConditions.other;
      }

      if (user.immunization_status != null) {
        let immunizationStatus = JSON.parse(user.immunization_status);
        if (immunizationStatus.covid19 == true)
          selectImmunizationStatus.querySelector(
            "option[value='COVID-19']"
          ).selected = true;
        if (immunizationStatus.flu == true)
          selectImmunizationStatus.querySelector(
            "option[value='Flu']"
          ).selected = true;
        if (immunizationStatus.hepatitisb == true)
          selectImmunizationStatus.querySelector(
            "option[value='Hepatitis B']"
          ).selected = true;
        if (immunizationStatus.tetanus == true)
          selectImmunizationStatus.querySelector(
            "option[value='Tetanus']"
          ).selected = true;
        if (immunizationStatus.mmr == true)
          selectImmunizationStatus.querySelector(
            "option[value='MMR']"
          ).selected = true;
        if (immunizationStatus.other != null)
          inputOtherImmunizationStatus.value = immunizationStatus.other;
      }

      if (user.major_illnesses != null)
        inputMajorIllnesses.value = user.major_illnesses;
      if (user.current_medications != null)
        inputCurrentMedications.value = user.current_medications;
      if (user.family_medical_history != null)
        inputFamilyMedicalHistory.value = user.family_medical_history;
      if (user.smoking_status != null)
        selectSmokingStatus.value = user.smoking_status;
      if (user.alcohol_use != null) selectAlcoholUse.value = user.alcohol_use;
      if (user.physical_activity != null)
        selectPhysicalActivity.value = user.physical_activity;
      if (user.dietary_habits != null)
        inputDietaryHabits.value = user.dietary_habits;
      if (user.last_updated != null)
        panelLastUpdated.textContent = new Date(
          user.last_updated * 1000
        ).toLocaleString();
    }

    btnBack.onclick = () => (location.href = "profile.html");

    btnSave.onclick = async () => {
      let chronicConditions = {
        diabetes: selectChronicConditions.querySelector(
          "option[value='Diabetes']"
        ).selected,
        hypertension: selectChronicConditions.querySelector(
          "option[value='Hypertension']"
        ).selected,
        asthma: selectChronicConditions.querySelector(
          "option[value='Asthma']"
        ).selected,
        kidneydisease: selectChronicConditions.querySelector(
          "option[value='Kidney Disease']"
        ).selected,
        heartdisease: selectChronicConditions.querySelector(
          "option[value='Heart Disease']"
        ).selected,
        cancer: selectChronicConditions.querySelector(
          "option[value='Cancer']"
        ).selected,
        epilepsy: selectChronicConditions.querySelector(
          "option[value='Epilepsy']"
        ).selected,
        other: inputOtherChronicConditions.value,
      };

      let immunizationStatus = {
        covid19: selectImmunizationStatus.querySelector(
          "option[value='COVID-19']"
        ).selected,
        flu: selectImmunizationStatus.querySelector("option[value='Flu']")
          .selected,
        hepatitisb: selectImmunizationStatus.querySelector(
          "option[value='Hepatitis B']"
        ).selected,
        tetanus: selectImmunizationStatus.querySelector(
          "option[value='Tetanus']"
        ).selected,
        mmr: selectImmunizationStatus.querySelector("option[value='MMR']")
          .selected,
        other: inputOtherImmunizationStatus.value,
      };

      let response = await fetch("api/user/medical/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: g_data.session,
        },
        body: JSON.stringify({
          height: Number(inputHeight.value),
          weight: Number(inputWeight.value),
          blood_type: selectBloodType.value,
          allergies: inputAllergies.value,
          chronic_conditions: JSON.stringify(chronicConditions),
          immunization_status: JSON.stringify(immunizationStatus),
          major_illnesses: inputMajorIllnesses.value,
          current_medications: inputCurrentMedications.value,
          family_medical_history: inputFamilyMedicalHistory.value,
          smoking_status: selectSmokingStatus.value,
          alcohol_use: selectAlcoholUse.value,
          physical_activity: selectPhysicalActivity.value,
          dietary_habits: inputDietaryHabits.value,
        }),
      });

      let json = await response.json();
      console.log(json);
      location.href = "profile.html";
    };
  </script>
</body>

</html>